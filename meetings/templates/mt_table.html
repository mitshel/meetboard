{% extends "mb_main.html" %}
{% load staticfiles %}
{% load i18n %}

{% block content %}
    <div class="row">
    <div class="col-sm-12">
        <div class="btn-group" role="group" aria-label="meetings menu">
              <a type="button" class="btn btn-primary" href="{% url 'meetings:add' %}"><i class="fa fa-plus"></i> Создать совещание </a>
              <a type="button" class="btn btn-primary" href="{% url 'meetings:plandoc' %}"><i class="fa fa-list"></i> Шаблон плана подготовки </a>
        </div>
    </div>
    </div>

    <br>

    <!-- ------------------------------------------- -->
    <!-- meetingDeleteModal ------------------------ -->
    <!-- ------------------------------------------- -->
    <div class="modal" id="meetingDeleteModal" tabindex="-1" role="dialog" aria-labelledby="meetingDeleteModalTitle" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="meetingDeleteModalTitle">Удаление совещания</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
               Вы действительно хотите удалить совещание <b>"<span></span>"</b>?
          </div>
          <div class="modal-footer">
            <a type="button" class="btn btn-secondary" data-dismiss="modal" href="#">Выйти без удаления</a>
            <a type="button" class="btn btn-primary" href="#" id="meetingDeleteButton">Удалить совещание</a>
          </div>
        </div>
      </div>
    </div>

    <!-- ------------------------------------------- -->
    <!-- membersModal ------------------------------ -->
    <!-- ------------------------------------------- -->
    <div class="modal members-modal-lg" tabindex="-1" role="dialog" id="membersModal" data-backdrop="static" data-keyboard="false">
      <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
              <span class="modal-title">Участники совещания</span>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>

          <div class="modal-body mx-auto">
              <form action="{% url 'meetings:membersupd' %}" method="post" id="members_form">
              {% csrf_token %}
              <table id="membersTable"> </table>
              <input type="hidden" name="meet_id" value="0" id="members_meet_id"/>
              <br>
              </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
            <button type="button" class="btn btn-primary" data-dismiss="modal" id="membersSave">Сохранить</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ------------------------------------------- -->
    <!-- itemsModal -------------------------------- -->
    <!-- ------------------------------------------- -->
    <div class="modal items-modal-lg" tabindex="-1" role="dialog" id="itemsModal" data-backdrop="static" data-keyboard="false">
      <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
              <span class="modal-title">Повестка совещания</span>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>

          <div class="modal-body mx-auto">
              <form action="{% url 'meetings:itemsupd' %}" method="post" id="items_form">
              {% csrf_token %}
              <table id="itemsTable"> </table>
              <input type="hidden" name="meet_id" value="0" id="items_meet_id"/>
              <br>
              </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
            <button type="button" class="btn btn-primary" data-dismiss="modal" id="itemsSave">Сохранить</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ------------------------------------------- -->
    <!-- employeeSearchModal ------------------------------ -->
    <!-- ------------------------------------------- -->
    <div class="modal employee-modal-md" tabindex="-1" role="dialog" id="employeeModal" data-backdrop="static" data-keyboard="true">
      <div class="modal-dialog modal-dialog-centered modal-md" role="document">
        <div class="modal-content">
          <div class="modal-header">
              <span class="modal-title">Сотрудники</span>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>

          <div class="modal-body">
                 <label for="inputEmployee">Введите фамилию для поиска сотрудника:</label>
                 <input class="typeahead form-control" type="text" data-provide="typeahead" data-items="8" id="inputEmployee">
                 <br>
                 <div class="row">
                     <div class="col-4">
                         <label for="employeeF">Фамилия:</label>
                         <input type="text" class="form-control form-control-sm" id="employeeF" name="employeeF" readonly>
                     </div>
                     <div class="col-4">
                         <label for="employeeI">Имя:</label>
                         <input type="text" class="form-control form-control-sm" id="employeeI" name="employeeI" readonly>
                     </div>
                     <div class="col-4">
                         <label for="employeeO">Отчество:</label>
                         <input type="text" class="form-control form-control-sm" id="employeeO" name="employeeO" readonly>
                     </div>
                     <div class="col-12">
                         <label for="employeeDol">Должность:</label>
                         <input type="text" class="form-control form-control-sm" id="employeeDol" name="employeeDol" readonly>
                     </div>
                     <div class="col-12">
                         <label for="employeeDep">Организация:</label>
                         <input type="text" class="form-control form-control-sm" id="employeeDep" name="employeeDep" readonly>
                     </div>
                 </div>
                 <input type="hidden" id="employeeRowIndex" name="employeeRowIndex">
                 <input type="hidden" id="employeeId" name="employeeId">
                 <input type="hidden" id="employeeTable" name="employeeTable">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
            <button type="button" class="btn btn-primary" data-dismiss="modal" id="employeeSelect">Выбрать</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ------------------------------------------- -->
    <!-- studiosModal ------------------------------ -->
    <!-- ------------------------------------------- -->
    <div class="modal studios-modal-lg" tabindex="-1" role="dialog" id="studiosModal" data-backdrop="static" data-keyboard="false">
      <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
              <span class="modal-title">Студии</span>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>

          <div class="modal-body mx-auto">
              <form action="{% url 'meetings:studiosupd' %}" method="post" id="studios_form">
              {% csrf_token %}
              <table id="studiosTable"> </table>
              <input type="hidden" name="meet_id" value="0" id="studios_meet_id"/>
              <br>
              </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
            <button type="button" class="btn btn-primary" data-dismiss="modal" id="studiosSave">Сохранить</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ------------------------------------------- -->
    <!-- checksModal  ------------------------------ -->
    <!-- ------------------------------------------- -->
    <div class="modal checks-modal-lg" tabindex="-1" role="dialog" id="checksModal" data-backdrop="static" data-keyboard="false">
      <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
              <span class="modal-title">Контроль подготовки совещания</span>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>

          <div class="modal-body mx-auto">
              <form action="{% url 'meetings:checksupd' %}" method="post" id="checks_form">
              {% csrf_token %}
                    <table class="table table-sm table-hover table-bordered" id="checkTable" style="font-size: 0.9rem;">
                      <thead>
                        <tr>
                          <th scope="col">п/п</th>
                          <th scope="col">Видео</th>
                          <th scope="col">Селектор</th>
                          <th scope="col">Очное</th>
                          <th scope="col">Загружено в САД</th>
                          <th scope="col">Отправлено по @</th>
                          <th scope="col">Отправлено экспед.</th>
                          <th scope="col">Выполнено</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <th scope="row">1.</th>
                          <td colspan="3">Определить дату, время, тему совещания (Спросить у инициатора совещания)</td>
                          <td id="tdp1_1" style="text-align: center;"><b>X</b></td>
                          <td id="tdp1_2" style="text-align: center;"><b>X</b></td>
                          <td id="tdp1_3" style="text-align: center;"><b>X</b></td>
                          <td id="tdp1_4" style="text-align: center;">
                              <div class="form-group form-check">
                                <input type="checkbox" class="form-check-input" id="p1_4" name="p1_4">
                              </div>
                          </td>
                        </tr>
                        <tr>
                          <th scope="row">2.</th>
                          <td colspan="3">Составить список участников (Спросить у инициатора совещания)</td>
                          <td id="tdp2_1" style="text-align: center;"><b>X</b></td>
                          <td id="tdp2_2" style="text-align: center;"><b>X</b></td>
                          <td id="tdp2_3" style="text-align: center;"><b>X</b></td>
                          <td id="tdp2_4" style="text-align: center;">
                              <div class="form-group form-check">
                                <input type="checkbox" class="form-check-input" id="p2_4" name="p2_4">
                              </div>
                          </td>
                        </tr>
                        <tr>
                          <th scope="row">3.</th>
                          <td colspan="3">Составить повестку совещания (Спросить у инициатора совещания)</td>
                          <td id="tdp3_1" style="text-align: center;"><b>X</b></td>
                          <td id="tdp3_2" style="text-align: center;"><b>X</b></td>
                          <td id="tdp3_3" style="text-align: center;"><b>X</b></td>
                          <td id="tdp3_4" style="text-align: center;">
                              <div class="form-group form-check">
                                <input type="checkbox" class="form-check-input" id="p3_4" name="p3_4">
                              </div>
                          </td>
                        </tr>
                        <tr>
                          <th scope="row">4.</th>
                          <td colspan="3">Позвонить всем участникам, выяснить все ньюансы их участия</td>
                          <td id="tdp4_1" style="text-align: center;"><b>X</b></td>
                          <td id="tdp4_2" style="text-align: center;"><b>X</b></td>
                          <td id="tdp4_3" style="text-align: center;"><b>X</b></td>
                          <td id="tdp4_4" style="text-align: center;">
                              <div class="form-group form-check">
                                <input type="checkbox" class="form-check-input" id="p4_4" name="p4_4">
                              </div>
                          </td>
                        </tr>
                        <tr>
                          <th scope="row">5.</th>
                          <td colspan="3">Написать всем письмо, об участии в совещании</td>
                          <td id="tdp5_1" style="text-align: center;">
                              <div class="form-group form-check">
                                <input type="checkbox" class="form-check-input" id="p5_1" name="p5_1">
                              </div>
                          </td>
                          <td id="tdp5_2" style="text-align: center;">
                              <div class="form-group form-check">
                                <input type="checkbox" class="form-check-input" id="p5_2" name="p5_2">
                              </div>
                          </td>
                            <td id="tdp5_3" style="text-align: center;">
                              <div class="form-group form-check">
                                <input type="checkbox" class="form-check-input" id="p5_3" name="p5_3">
                              </div>
                          </td>
                          <td id="tdp5_4" style="text-align: center;">
                              <div class="form-group form-check">
                                <input type="checkbox" class="form-check-input" id="p5_4" name="p5_4">
                              </div>
                          </td>
                        </tr>
                        <tr>
                          <th scope="row">6.</th>
                          <td colspan="3">Разослать список участников и повестку совещания всем участникам</td>
                          <td id="tdp6_1" style="text-align: center;"><b>X</b></td>
                          <td id="tdp6_2" style="text-align: center;">
                              <div class="form-group form-check">
                                <input type="checkbox" class="form-check-input" id="p6_2" name="p6_2">
                              </div>
                          </td>
                          <td id="tdp6_3" style="text-align: center;"><b>X</b></td>
                          <td id="tdp6_4" style="text-align: center;">
                              <div class="form-group form-check">
                                <input type="checkbox" class="form-check-input" id="p6_4" name="p6_4">
                              </div>
                          </td>
                        </tr>
                        <tr>
                          <th scope="row">7.</th>
                          <td>Зарезервировать студию</td>
                          <td style="text-align: center;"><b>X</b></td>
                          <td style="text-align: center;"><b>X</b></td>
                          <td id="tdp7_1" style="text-align: center;"><b>X</b></td>
                          <td id="tdp7_2" style="text-align: center;"><b>X</b></td>
                          <td id="tdp7_3" style="text-align: center;"><b>X</b></td>
                          <td id="tdp7_4" style="text-align: center;">
                              <div class="form-group form-check">
                                <input type="checkbox" class="form-check-input" id="p7_4" name="p7_4">
                              </div>
                          </td>
                        </tr>
                        <tr>
                          <th scope="row">8.</th>
                          <td>Узнать адреса студий участников</td>
                          <td style="text-align: center;"><b>X</b></td>
                          <td style="text-align: center;"><b>X</b></td>
                          <td id="tdp8_1" style="text-align: center;"><b>X</b></td>
                          <td id="tdp8_2" style="text-align: center;"><b>X</b></td>
                          <td id="tdp8_3" style="text-align: center;"><b>X</b></td>
                          <td id="tdp8_4" style="text-align: center;">
                              <div class="form-group form-check">
                                <input type="checkbox" class="form-check-input" id="p8_4" name="p8_4">
                              </div>
                          </td>
                        </tr>
                        <tr>
                          <th scope="row">9.</th>
                          <td>Отправить служебку о подключении ВКС</td>
                          <td style="text-align: center;"><b>X</b></td>
                          <td style="text-align: center;"><b>X</b></td>
                          <td id="tdp9_1" style="text-align: center;">
                              <div class="form-group form-check">
                                <input type="checkbox" class="form-check-input" id="p9_1" name="p9_1">
                              </div>
                          </td>
                          <td id="tdp9_2" style="text-align: center;"><b>X</b></td>
                          <td id="tdp9_3" style="text-align: center;"><b>X</b></td>
                          <td id="tdp9_4" style="text-align: center;">
                              <div class="form-group form-check">
                                <input type="checkbox" class="form-check-input" id="p9_4" name="p9_4">
                              </div>
                          </td>
                        </tr>
                        <tr>
                          <th scope="row">10.</th>
                          <td>Позвонить по номеру 9-10-10, сказать номер служебки</td>
                          <td>Позвонить по номеру 9-10-10, сообщить номера телефонов участников</td>
                          <td>Уточнить всех прибывших на совещание</td>
                          <td id="tdp10_1" style="text-align: center;"><b>X</b></td>
                          <td id="tdp10_2" style="text-align: center;"><b>X</b></td>
                          <td id="tdp10_3" style="text-align: center;"><b>X</b></td>
                          <td id="tdp10_4" style="text-align: center;">
                              <div class="form-group form-check">
                                <input type="checkbox" class="form-check-input" id="p10_4" name="p10_4">
                              </div>
                          </td>
                        </tr>
                        <tr>
                          <th scope="row">11.</th>
                          <td style="text-align: center;"><b>X</b></td>
                          <td style="text-align: center;"><b>X</b></td>
                          <td style="text-align: center;">Обеспечить всех участников материалами к совещанию</td>
                          <td id="tdp11_1" style="text-align: center;">
                              <div class="form-group form-check">
                                <input type="checkbox" class="form-check-input" id="p9_1" name="p9_1">
                              </div>
                          </td>
                          <td id="tdp11_2" style="text-align: center;"><b>X</b></td>
                          <td id="tdp11_3" style="text-align: center;"><b>X</b></td>
                          <td id="tdp11_4" style="text-align: center;">
                              <div class="form-group form-check">
                                <input type="checkbox" class="form-check-input" id="p11_4" name="p11_4">
                              </div>
                          </td>
                        </tr>
                      </tbody>
                    </table>
              <input type="hidden" name="meet_id" value="0" id="checks_meet_id"/>
              <br>
              </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
            <button type="button" class="btn btn-primary" data-dismiss="modal" id="checksSave">Сохранить</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ------------------------------------------- -->
    <!-- meetTable          ------------------------ -->
    <!-- ------------------------------------------- -->
    <table class="table table-sm table-hover display" id="meetTable">
      <thead>
        <tr>
          <th scope="col">Действия</th>
          <th scope="col">Дата</th>
          <th scope="col">Тема</th>
          <!--<th scope="col">Место</th>-->
          <th scope="col">Время</th>
          <th scope="col">Ответственный</th>
          <th scope="col">Участники</th>
          <th scope="col">Повестка</th>
          <th scope="col">Студии</th>
        </tr>
      </thead>
      <tbody>
      {% for m in meetings %}
        <tr>
          <th scope="row">
              <a href="#" data-toggle="tooltip" data-placement="top" title="Удалить совещание" onClick="$('#meetingDeleteButton').attr('href','{% url 'meetings:delete' m.id %}');$('#meetingDeleteModal').find('div.modal-body').find('span').text('{{ m.meet_subj }}');$('#meetingDeleteModal').modal('show');"><i class="fa fa-trash"></i></a>
              <a href="{% url 'meetings:update' m.id %}" data-toggle="tooltip" data-placement="top" title="Изменить данные"><i class="fa fa-edit"></i></a>
              <a href="{% url 'meetings:copy' m.id %}" data-toggle="tooltip" data-placement="top" title="Скопировать"><i class="fa fa-copy"></i></a>
              <a href="#" data-toggle="tooltip" data-placement="top" title="Контроль" onClick="showCheckWindow({{ m.id }});"><i class="fa fa-check-square"></i></a>
          </th>
          <td>{{ m.meet_date | date:"d.m.Y" }}</td>
          <td {% if m.meet_subj == '' %}class="table-warning"{% endif %}>{{ m.meet_subj }}</td>
          <!--<td>{{ m.meet_place }}</td>-->
          <td {% if m.meet_start == '' %}class="table-warning"{% endif %}>{{ m.meet_start }}-{{ m.meet_end }}</td>
          <td {% if m.meet_acc == '' %}class="table-warning"{% endif %}><span class='arrow' data-toggle="tooltip" data-placement="top" title="{{ m.meet_tel }}">{{ m.meet_acc }}</span></td>
          <td {% if m.members_cnt == 0 %}class="table-warning"{% endif %}>
               <a href="#" data-toggle="modal" data-target=".members-modal-lg" data-meet="{{ m.id }}" data-subj="{{ m.meet_subj }}" data-dt="{{ m.meet_date }}">Участники</a>
               <a href="{% url 'meetings:membersdoc' m.id %}" target='_blank' data-toggle="tooltip" data-placement="top" title="Формировать список участников" onClick=""><i class="fa fa-users"></i></a>
          </td>
          <td {% if m.items_cnt == 0 %}class="table-warning"{% endif %}>
              <a href="#" data-toggle="modal" data-target=".items-modal-lg" data-meet="{{ m.id }}" data-subj="{{ m.meet_subj }}" data-dt="{{ m.meet_date }}">Повестка</a>
              <a href="{% url 'meetings:itemsdoc' m.id %}" target='_blank' data-toggle="tooltip" data-placement="top" title="Формировать повестку" onClick=""><i class="fa fa-list"></i></a>
          </td>
          <td {% if m.studios_cnt == 0 %}class="table-warning"{% endif %}>
              <a href="#" data-toggle="modal" data-target=".studios-modal-lg" data-meet="{{ m.id }}" data-subj="{{ m.meet_subj }}" data-dt="{{ m.meet_date }}">Студии</a>
              <a href="{% url 'meetings:studiosdoc' m.id %}" target='_blank' data-toggle="tooltip" data-placement="top" title="Формировать заявку" onClick=""><i class="fa fa-file"></i></a>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
{% endblock %}  {# content #}

{% block js-block %}
<script src="{% static "js/jquery.tabledit.min.js" %}"></script>
<script type="text/javascript" src="{% static "appendGrid/jquery.appendGrid-1.7.1.min.js" %}"></script>
<script type="text/javascript">

////////////////////////////////////////////////////////////////
// meetTable Settings and Functions
//
$(document).ready( function () {

    $('#meetTable').DataTable({
            "language": {
                          "processing": "Подождите...",
                          "search": "Поиск:",
                          "lengthMenu": "Показать _MENU_ записей",
                          "info": "Записи с _START_ до _END_ из _TOTAL_ записей",
                          "infoEmpty": "Записи с 0 до 0 из 0 записей",
                          "infoFiltered": "(отфильтровано из _MAX_ записей)",
                          "infoPostFix": "",
                          "loadingRecords": "Загрузка записей...",
                          "zeroRecords": "Записи отсутствуют.",
                          "emptyTable": "В таблице отсутствуют данные",
                          "paginate": {
                            "first": "Первая",
                            "previous": "Предыдущая",
                            "next": "Следующая",
                            "last": "Последняя"
                          },
                          "aria": {
                            "sortAscending": ": активировать для сортировки столбца по возрастанию",
                            "sortDescending": ": активировать для сортировки столбца по убыванию"
                          }
                        }
        });
} );

////////////////////////////////////////////////////////////////
// membersModal Settings and Functions
//
$('#membersModal').on('show.bs.modal', function (event) {
    var button = $(event.relatedTarget); // Button that triggered the modal
    var meet = button.data('meet'); // Extract info from data-* attributes
    var subj = button.data('subj'); // Extract info from data-* attributes
    var dt = button.data('dt'); // Extract info from data-* attributes

    var modal = $('#membersModal');
    modal.find('.modal-title').html('Участники совещания: <b>"' + subj + '"</b><br>Дата совещания: <b>'+dt+'</b>');
    $('#members_meet_id').attr('value',meet);

    // Удаляем все данные таблицы
    while ($('#membersTable').appendGrid('getRowCount')>0)  {
      $('#membersTable').appendGrid('removeRow', 0);
    };

    // Загружаем данные из БД
    var request = $.ajax({
        url: "{% url 'meetings:membersget' 999 %}".replace('999', meet),
        type: "POST",
        data: { csrfmiddlewaretoken: '{{ csrf_token }}' },
        dataType: "json",
        success: function(msg) {
            $('#membersTable').appendGrid('load', msg);
        }
    });

});

$(function () {
    $('#membersTable').appendGrid({caption: 'Участники совещания',
        initRows: 0,
        rowDragging: true,
        hideButtons: { moveUp: true, moveDown: true },
        columns: [
            { name: 'dep', display: 'Организация', ctrlCss: { width: '250px'}, type: 'select', ctrlOptions:
                    [
                        {% autoescape off %}
                        {% for d in deps %}
                            '{{ d.name }}',
                        {% endfor %}
                        {% endautoescape %}
                    ] },
            { name: 'f', display: 'Фамилия', type: 'text', ctrlAttr: { maxlength: 32 } },
            { name: 'i', display: 'Имя', type: 'text', ctrlAttr: { maxlength: 32} },
            { name: 'o', display: 'Отчество', type: 'text', ctrlAttr: { maxlength: 32} },
            { name: 'dol', display: 'Должность', type: 'text', ctrlAttr: { maxlength: 64} },
            { name: 'is_lead', display: 'Вед.', type: 'checkbox' , onChange: handle_lead},
            { name: 'is_init', display: 'Иниц.', type: 'checkbox', onChange: handle_init},
            { name: 'is_speaker', display: 'Докл.', type: 'checkbox' },
            { name: 'Id', type: 'hidden', value: 0 },
            { name: 'eId', type: 'hidden', value: 0 },
        ],
        customRowButtons: [
              { uiButton: { icon: 'ui-icon-person', showLabel: false }, click: selectEmployee, btnCss: { 'min-width': '30px' }, btnAttr: { title: 'Выбрать сотрудника' }, atTheFront: true },
        ],
        i18n: {
            append: 'Добавить запись',
            removeLast: 'Удалить последнюю запись',
            insert: 'Вставить запись',
            remove: 'Удалить запись',
            moveUp: 'Вверх',
            moveDown: 'Вниз',
        }
    });

    // Handle `Save` button click
    $('#membersSave').button().click(function () {
        msg = $(document.forms[0]).serialize();
        action_url = $('#members_form').attr("action");

        $.ajax({
            type: 'POST',
            url: action_url,
            data: msg,
            success: function (data) {},
            error: function (xhr, str) {}
        });

        $('#membersModal').modal('hide');
        return false;
    });
});

function handle_lead(evt, rowIndex) {
    var elem = evt.target;
    if ($('#membersTable').appendGrid('getCtrlValue', 'is_lead', rowIndex)) {
        var rowCount = $('#membersTable').appendGrid('getRowCount');
        for (var i = 0; i < rowCount; i++) {
            if (i != rowIndex)
                $('#membersTable').appendGrid('setCtrlValue', 'is_lead', i, 0);
        }
    }
}

function handle_init(evt, rowIndex) {
    var elem = evt.target;
    if ($('#membersTable').appendGrid('getCtrlValue', 'is_init', rowIndex)) {
        var rowCount = $('#membersTable').appendGrid('getRowCount');
        for (var i = 0; i < rowCount; i++) {
            if (i != rowIndex)
                $('#membersTable').appendGrid('setCtrlValue', 'is_init', i, 0);
        }
    }
}

////////////////////////////////////////////////////////////////
// itemsModal Settings and Functions
//
$('#itemsModal').on('show.bs.modal', function (event) {
    var button = $(event.relatedTarget); // Button that triggered the modal
    var meet = button.data('meet'); // Extract info from data-* attributes
    var subj = button.data('subj'); // Extract info from data-* attributes
    var dt = button.data('dt'); // Extract info from data-* attributes

    var modal = $('#itemsModal');
    modal.find('.modal-title').html('Повестка совещания: <b>"' + subj + '"</b><br>Дата совещания: <b>'+dt+'</b>');
    $('#items_meet_id').attr('value',meet);

    // Удаляем все данные таблицы
    while ($('#itemsTable').appendGrid('getRowCount')>0)  {
      $('#itemsTable').appendGrid('removeRow', 0);
    };

    // Загружаем данные из БД
    var request = $.ajax({
        url: "{% url 'meetings:itemsget' 999 %}".replace('999', meet),
        type: "POST",
        data: { csrfmiddlewaretoken: '{{ csrf_token }}' },
        dataType: "json",
        success: function(msg) {
            $('#itemsTable').appendGrid('load', msg);
            $('#itemsTable').appendGrid('load', msg);
        }
    });

});

$(function () {
    $('#itemsTable').appendGrid({caption: 'Повестка совещания',
        initRows: 0,
        columns: [
            { name: 'dep', display: 'Организация', ctrlCss: { width: '250px'}, type: 'select', ctrlOptions:
                    [
                        {% autoescape off %}
                        {% for d in deps %}
                            '{{ d.name }}',
                        {% endfor %}
                        {% endautoescape %}
                    ] },
            { name: 'f', display: 'Фамилия', type: 'text', ctrlAttr: { maxlength: 32 } },
            { name: 'i', display: 'Имя', type: 'text', ctrlAttr: { maxlength: 32} },
            { name: 'o', display: 'Отчество', type: 'text', ctrlAttr: { maxlength: 32} },
            { name: 'dol', display: 'Должность', type: 'text', ctrlAttr: { maxlength: 64} },
            { name: 'item_time', display: 'Время', type: 'text', ctrlAttr: { maxlength: 32} },
            { name: 'Id', type: 'hidden', value: 0 },
            { name: 'eId', type: 'hidden', value: 0 },
        ],
        customRowButtons: [
              { uiButton: { icon: 'ui-icon-person', showLabel: false }, click: selectEmployee, btnCss: { 'min-width': '30px' }, btnAttr: { title: 'Выбрать сотрудника' }, atTheFront: true },
        ],
        i18n: {
            append: 'Добавить запись',
            removeLast: 'Удалить последнюю запись',
            insert: 'Вставить запись',
            remove: 'Удалить запись',
            moveUp: 'Вверх',
            moveDown: 'Вниз',
        },
        useSubPanel: true,
        subPanelBuilder: function (cell, uniqueIndex) {
            // Create a label
            $('<span></span>').text('Тема выступления: ').appendTo(cell);
            // Create a text area
            $('<textarea></textarea>').css('vertical-align', 'middle').attr({
                id: 'itemsTable_item_subj_' + uniqueIndex,
                name: 'itemsTable_item_subj_' + uniqueIndex,
                rows: 1, cols: 140
            }).appendTo(cell);
        },
        subPanelGetter: function (uniqueIndex) {
            // Return the element value inside sub panel for `getAllValue` and `getRowValue` methods
            return { 'item_subj': $('#itemsTable_item_subj_' + uniqueIndex).val() };
        },
        rowDataLoaded: function (caller, record, rowIndex, uniqueIndex) {
            // Check the record contains `item_subj`
            if (record.item_subj) {
                // Get the control in sub panel
                var elem = document.getElementById('itemsTable_item_subj_' + uniqueIndex);
                // Fill the comment values in the sub panel
                elem.value = record.item_subj;
            }
        }
    });

    // Handle `Save` button click
    $('#itemsSave').button().click(function () {
        msg = $(document.forms[1]).serialize();
        action_url = $('#items_form').attr("action");

        $.ajax({
            type: 'POST',
            url: action_url,
            data: msg,
            success: function (data) {},
            error: function (xhr, str) {}
        });

        $('#itemsModal').modal('hide');
        return false;
    });
});

var $inputEmployee = $("#inputEmployee");

function selectEmployee(evtObj, uniqueIndex, rowData) {
    $inputEmployee.val(rowData.f);
    $("#employeeF").val("")
    $("#employeeI").val("")
    $("#employeeO").val("")
    $("#employeeDol").val("")
    $("#employeeDep").val("")
    $("#employeeId").val(0)
    // Вычисляем и запоминаем из какой таблицы был вызов #membersTable или #itemsTable
    $("#employeeTable").val(evtObj.data.tbWhole.id)
    $("#employeeRowIndex").val(uniqueIndex)
    $('#employeeModal').modal('show');
    // Check the caller button exist in event object
    //if (evtObj && evtObj.target) {
        // Do something on the button, such as disable the button
    //    $(evtObj.target).button('disable');
    //}
}

$('#employeeSelect').button().click(function () {
    var idx = $("#employeeRowIndex").val()-1;
    var tbl ='#'+$("#employeeTable").val()
    $(tbl).appendGrid('setCtrlValue', 'f', idx, $("#employeeF").val());
    $(tbl).appendGrid('setCtrlValue', 'i', idx, $("#employeeI").val());
    $(tbl).appendGrid('setCtrlValue', 'o', idx, $("#employeeO").val());
    $(tbl).appendGrid('setCtrlValue', 'dep', idx, $("#employeeDep").val());
    $(tbl).appendGrid('setCtrlValue', 'dol', idx, $("#employeeDol").val());
    $(tbl).appendGrid('setCtrlValue', 'eId', idx, $("#employeeId").val());
});

$inputEmployee.typeahead({
  source: [
          {% for e in employees %}{name:"{{ e.f }} {{ e.i }} {{ e.o }}",id:"{{ e.id }}", f:"{{ e.f }}", i:"{{ e.i }}", o:"{{ e.o }}", dol:"{{ e.dol }}", dep:"{{ e.dep }}"}{% if not forloop.last %},{% endif %}{% endfor %}
  ],
  autoSelect: true
});

$inputEmployee.change(function() {
  var current = $inputEmployee.typeahead("getActive");
  if (current) {
    // Some item from your model is active!
    $("#employeeF").val(current.f)
    $("#employeeI").val(current.i)
    $("#employeeO").val(current.o)
    $("#employeeId").val(current.id)
    $("#employeeDol").val(current.dol.replace(/&quot;/g,'"'))
    $("#employeeDep").val(current.dep.replace(/&quot;/g,'"'))
    if (current.name == $inputEmployee.val()) {
      // This means the exact match is found. Use toLowerCase() if you want case insensitive match.
    } else {
      // This means it is only a partial match, you can either add a new item
      // or take the active if you don't want new items
        // Выбор осещетсвлен из выпадающего списка по части строки
    }
  } else {
    // Nothing is active so it is a new value (or maybe empty value)
  }
});

////////////////////////////////////////////////////////////////
// studiosModal Settings and Functions
//
$('#studiosModal').on('show.bs.modal', function (event) {
    var button = $(event.relatedTarget); // Button that triggered the modal
    var meet = button.data('meet'); // Extract info from data-* attributes
    var subj = button.data('subj'); // Extract info from data-* attributes
    var dt = button.data('dt'); // Extract info from data-* attributes

    var modal = $('#studiosModal');
    modal.find('.modal-title').html('Студии совещания: <b>"' + subj + '"</b><br>Дата совещания: <b>'+dt+'</b>');
    $('#studios_meet_id').attr('value',meet);

    // Удаляем все данные таблицы
    while ($('#studiosTable').appendGrid('getRowCount')>0)  {
      $('#studiosTable').appendGrid('removeRow', 0);
    };

    // Загружаем данные из БД
    var request = $.ajax({
        url: "{% url 'meetings:studiosget' 999 %}".replace('999', meet),
        type: "POST",
        data: { csrfmiddlewaretoken: '{{ csrf_token }}' },
        dataType: "json",
        success: function(msg) {
            $('#studiosTable').appendGrid('load', msg);
        }
    });
});

$(function () {
    $('#studiosTable').appendGrid({caption: 'Студии совещания',
        initRows: 0,
        rowDragging: true,
        hideButtons: { moveUp: true, moveDown: true },
        columns: [
            { name: 'studio__dep_id', display: 'Организация', ctrlCss: { width: '250px'}, type: 'select',
                ctrlOptions: [
                    {% autoescape off %}
                        {value:0, label : '{Выберите организацию}'},
                        {% for d in deps %}
                            {% if d.studios_cnt > 0 %}
                                { value:{{ d.id }}, label : '{{ d.name }}'},
                            {% endif %}
                        {% endfor %}
                    {% endautoescape %}
                ],
                onChange: handle_studiosTableChange_dep,
            },
            {
                name: 'studio_id', display: 'Адрес студии', type: 'select',
                ctrlOptions: { 0: '{Выполните выбор нужной студии для совещания}' },
                onChange: handle_studiosTableChange_addr,
            },
            //{ name: 'studio_type', display: 'Тип', type: 'select', ctrlOptions: {0:'-', 1:'Видео', 2:'Аудио'}, ctrlAttr: { disabled: 'disabled' } },
            { name: 'Id', type: 'hidden', value: 0 },
        ],
        i18n: {
            append: 'Добавить запись',
            removeLast: 'Удалить последнюю запись',
            insert: 'Вставить запись',
            remove: 'Удалить запись',
            moveUp: 'Вверх',
            moveDown: 'Вниз',
        },
        // Поскольку каскадный выпадающий список пуст при вставке строки,
        // требуется после этого генерировать параметры и заполнять значения.
        rowDataLoaded: function (caller, record, rowIndex, uniqueIndex) {
            // Trigger rebuild the cascade drop down list if there is a valid value assigned
            if (0 < record.studio__dep_id) {
                var dep = $('#studiosTable').appendGrid('getCellCtrl', 'studio__dep_id', rowIndex);
                $(dep).trigger('change');
                // Check value of cascade 2
                var studio = $('#studiosTable').appendGrid('getCellCtrl', 'studio_id', rowIndex);
                if (0 < record.studio_id) {
                    $(studio).val(record.studio_id).trigger('change');
                }
            }
        }
    });

    function handle_studiosTableChange_dep(evt, rowIndex) {
        // Get the select elements
        var elem1 = evt.target;
        var elem2 = $('#studiosTable').appendGrid('getCellCtrl', 'studio_id', rowIndex);
        var elem3 = $('#studiosTable').appendGrid('getCellCtrl', 'studio_type', rowIndex);
        // Clear the generated options in elem2 and elem3
        elem2.options.length = 1;
        // Check if user selected a valid option
        if (0 < elem1.selectedIndex) {
            // Загружаем данные из БД для elem2
            $.ajax({
                url: "{% url 'meetings:studiosget_bydep' 999 %}".replace('999', elem1.value),
                type: "POST",
                async: false,
                data: { csrfmiddlewaretoken: '{{ csrf_token }}' },
                dataType: "json",
                success: function(msg) {
                            $.each(msg, function(key, val) {
                                elem2.options[key+1]=new Option(label=val.studio_addr, value=val.id);
	                        });
                }
            });
        }
    }
    function handle_studiosTableChange_addr(evt, rowIndex) {
        var elem2 = evt.target;
        var elem3 = $('#studiosTable').appendGrid('getCellCtrl', 'studio_type', rowIndex);
        //if (0 < elem2.selectedIndex) {
        //    if (elem2.prefix=='V') { elem3.selectedIndex=1 }
        //    else if (elem2.prefix=='A') { elem3.selectedIndex=2 }
        //    else { elem3.selectedIndex=0 };
        //}
        return false;
    }
    // Handle `Save` button click
    $('#studiosSave').button().click(function () {
        msg = $(document.forms[2]).serialize();
        action_url = $('#studios_form').attr("action");
        $.ajax({
            type: 'POST',
            url: action_url,
            data: msg,
            success: function (data) {},
            error: function (xhr, str) {}
        });

        $('#studiosModal').modal('hide');
        return false;
    });
});


////////////////////////////////////////////////////////////////
// checkModal Settings and Functions
//

function showCheckWindow(meet_id) {
    $('#checksModal').modal('show');
};

// Handle `Save` button click
$('#checksSave').button().click(function () {
    msg = $(document.forms[2]).serialize();
    action_url = $('#checks_form').attr("action");
    $.ajax({
        type: 'POST',
        url: action_url,
        data: msg,
        success: function (data) {},
        error: function (xhr, str) {}
    });

    $('#checksModal').modal('hide');
    return false;
});

</script>
{% endblock %}