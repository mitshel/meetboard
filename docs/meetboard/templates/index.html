
<style>
    /* Style the buttons that are used to open and close the accordion panel */
    button.accordion {
        background-color: #eee;
        color: #444;
        cursor: pointer;
        padding: 5px;
        width: 100%;
        text-align: left;
        border: none;
        outline: none;
        transition: 0.4s;
    }

    /* Add a background color to the button if it is clicked on (add the .active class with JS), and when you move the mouse over it (hover) */
    button.accordion.active, button.accordion:hover {
        background-color: #ddd;
    }

    /* Style the accordion panel. Note: hidden by default */
    div.panel {
        padding: 0 18px;
        background-color: white;
        display: none;
    }

    .hide
    {
    display:none;
    }
   
    .jsgrid {
  overflow: visible;
}

    .errorTr > td{ 
   background-color:rgba(255, 0, 0, 0.425)  !important;;
   }
   .jelti> td{ 
   background-color:rgba(234, 236, 77, 0.767)  !important;;
   }
   .sini > td{ 
   background-color:rgba(68, 161, 223, 0.596)  !important;;
   }
   .pribil> td{ 
   background-color:rgba(38, 241, 55, 0.479)  !important;;
   }
   .ubil > td{ 
   background-color:rgba(112, 112, 112, 0.897)  !important;;
   }

   .tridny > td{ 
   background-color:rgba(235, 150, 52, 0.897)  !important;;
   }


   .nichego > td{ 
   background-color:rgba(224, 224, 224, 0.897)  !important;;
   }



   .errorTr1{ 
   background-color:rgba(255, 0, 0, 0.425)  !important;;
   }
   .jelti1{ 
   background-color:rgba(234, 236, 77, 0.767)  !important;;
   }
   .sini1{ 
   background-color:rgba(68, 161, 223, 0.596)  !important;;
   }
   .pribil1{ 
   background-color:rgba(38, 241, 55, 0.479)  !important;;
   }
   .ubil1{ 
   background-color:rgba(112, 112, 112, 0.897)  !important;;
   }

   .tridny1{ 
   background-color:rgba(235, 150, 52, 0.897)  !important;;
   }


   .nichego1{ 
   background-color:rgba(224, 224, 224, 0.897)  !important;;
   }


  </style>

</style>

<style>
    .popup_overlay{
  display: none;
  background: rgba(0,0,0,.9);
  width: 100%;
  height: 100%;
  position: fixed;
  top: 0;
  left: 0;
}
.popup{
  display: none;
  background: #fff;
  box-shadow: 0 0 10px rgba(0,0,0,1);
  width: 600px;
  height: 500px;
  position: fixed;
  top: 50%;
  left: 50%;
  margin-left: -300px;
  margin-top: -250px;
}
.popup_title{
  font-weight: bold;
  padding: 10px;
}
.popup_content{
  padding: 10px;
  border-top: 1px solid #ccc;
}
.closer{
  float: right;
  cursor: pointer;
}
        .config-panel {
            padding: 10px;
            margin: 10px 0;
            background: #fcfcfc;
            border: 1px solid #e9e9e9;
            display: inline-block;
        }
    
        .config-panel label {
            margin-right: 10px;
        }


        .config-panelview {
            padding: 10px;
            margin: 10px 0;
            background: #fcfcfc;
            border: 1px solid #e9e9e9;
            display: inline-block;
        }
    
        .config-panelview label {
            margin-right: 10px;
        }
    </style>
    

    
<div class="container-fluid ">
        <div class="row content ">   
                <div class="row content ">
                <button class="btn btn-dark btn-sm buttonzoom  "  type="submit" onclick="myFunction()">Сортировка по цвету</button>
                <div class="config-panel" style="margin-top:-25px">
                        <label class="panzoom" ><input  id="heading" type="checkbox" checked /> Заголовоки</label>
                        <label  class="panzoom"><input  id="filtering" type="checkbox"  checked/> Фильтрация</label>
                        <label  class="panzoom"><input  id="inserting" type="checkbox" /> Вставка</label>
                        <label  class="panzoom"><input  id="editing" type="checkbox" checked /> Редактирование</label>
                             <!--     <label><input id="paging" type="checkbox" checked /> Страничник</label>-->
                      <!--  <label><input id="sorting" type="checkbox" checked /> Сортировка</label> -->
                        <label  class="panzoom"><input   id="selecting" type="checkbox" checked /> Выборка</label>
                    </div> 
               
                    <label style="float: right; margin-top:13px;margin-right:20px;vertical-align:center;" > <font size="4"  color="black" class="errorTr1">Ошибка</font>
                        <font size="4" color="black" class="tridny1">До выезда менее 3 дней</font>
                        <font size="4"  color="black" class="jelti1">Заезд в ближайшие 10 дней</font>
                        <font size="4" color="black" class="sini1">До заезда более 10 дней</font>
                        <font size="4"  color="black" class="pribil1">Заехал</font>
                        <font size="4"  color="black" class="ubil1">Выехал</font></label>       
                                 
            </div>  
     
            <div class="config-panelview" >
                    <label> <font size="3">Видимость столбцов:</font> </label>
                <label class="panzoom"><input id="config-panelview1" name="doljnost" type="checkbox" checked /> Должность</label>
                <label class="panzoom"><input id="config-panelview2" name="telephone" type="checkbox" checked /> Почта</label>
                <label class="panzoom"><input id="config-panelview3" name="propuskdata" type="checkbox" checked/> Пропуск</label>
                <label class="panzoom"><input id="config-panelview4" name="vremyzaezda" type="checkbox" checked/> Время заезда</label>
                <label class="panzoom"><input id="config-panelview5" name="comment" type="checkbox" checked/> Комментарии</label>
                <label class="panzoom"><input id="config-panelview6" name="gostinicaname" type="checkbox" checked/> Назв. гостиницы</label>
                <label class="panzoom"><input id="config-panelview7" name="kategoriyanomera" type="checkbox" checked/> Категория</label>
                <label class="panzoom"><input id="config-panelview8" name ="cenazasutki" type="checkbox" checked/> Номер аппарт.</label>
                <label class="panzoom"><input id="config-panelview9" name="kolvosutok" type="checkbox" checked /> Кол-во суток</label>
                <label class="panzoom"><input id="config-panelview10" name="massemailzasel" type="checkbox"  checked/> Массовая рассылка</label>
                <label class="panzoom"><input id="config-panelview11" name="control" type="checkbox"  checked/>Контроль</label>
                
                
            </div> 
            
        
                <div id="here_table">                   
                        <div id="jsGrid" class="scaleclass"></div>
                </div>

         </div>   
 </div>

<script type="text/javascript">
var promtptxt;
function getConfirmation(){

    
               var retVal = confirm("Вы уверены что хотите отправить письмо ?");
               if( retVal == true ){
                  return true;
               }
               else{
                  return false;
               }
            }

 function myFunctionPromt() {
   
    var person = prompt("На что жалоба ?", "");
    if (person == null || person == "") {
        return false;
    } else {
        promtptxt =person;
                 return true;
    }
  
}

function myFunction() {
    $("#jsGrid").jsGrid("sort", "sorterColor");
}
var jsonTable;
var jsonToSendMails = [];

function getQueries() {

 

    var xhr = new XMLHttpRequest();
   
    xhr.onreadystatechange = function () {
    if (this.readyState == 4) {
            if (this.status >= 200 && xhr.status < 300) {
                var jsonTable = JSON.parse(this.responseText);
                 /*    Начало дататаймпикер */
               
                 $("#pocvetu").button();
               /*    Конец дататаймпикер */
                var kategoriyanomeraselect = {
                    name: "kategoriyanomera",
                    type: "select",
                    items: [
                        { Name: "", Id: 0 },
                        { Name: "Студия", Id: 1 },
                        { Name: "Комфорт", Id: 2 } ],
                    valueField: "Id",
                    textField: "Name",
                    filtering: true,
                    width:50,
                    title: "Категория номера"
                    }
                        
                    var DateField = function(config) {
                        jsGrid.Field.call(this, config);
                    };
                    
                    DateField.prototype = new jsGrid.Field({
                        sorter: function(date1, date2) {
                            return new Date(date1) - new Date(date2);
                        },    
                        
                        itemTemplate: function(value) {
                            return new Date(value).toLocaleString('ru', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            });
                        },
                        
                        filterTemplate: function() {
                            var now = new Date();
                            this._fromPicker = $("<input>").datepicker({ defaultDate: now.setFullYear(now.getFullYear() - 1) });
                            this._toPicker = $("<input>").datepicker({ defaultDate: now.setFullYear(now.getFullYear() + 1) });
                            return $("<div>").append(this._fromPicker).append(this._toPicker);
                        },
                        
                        insertTemplate: function(value) {
                            return this._insertPicker = $("<input>").datepicker({ defaultDate: new Date() });
                        },
                        
                        editTemplate: function(value) {
                            return this._editPicker = $("<input>").datepicker().datepicker("setDate", new Date(value));
                        },
                        
                        insertValue: function() {
                            return this._insertPicker.datepicker("getDate");
                        },
                        
                        editValue: function() {
                            return this._editPicker.datepicker("getDate");
                        },
                        
                        filterValue: function() {
                            return {
                                from: this._fromPicker.datepicker("getDate"),
                                to: this._toPicker.datepicker("getDate")
                            };
                        }
                    });
                    
                    jsGrid.fields.date = DateField;
                   
                $("#jsGrid").jsGrid({
                   
                    controller: {
                  /*  loadData : function(filter) {    //Cерверный поиск
                        return $.ajax({
                                type : "Post",
                                url : "/searchGrid",
                                data :filter
                        });
                        
                    },*/
                    loadData: function(filter) {  //Клиентский поиск
                    return $.grep(jsonTable, function(jsonTable) {
                        return (!filter.fio || jsonTable.fio.indexOf(filter.fio) > -1)
                        && (!filter.gto || jsonTable.gto.indexOf(filter.gto) > -1)
                        && (!filter.kategoriyanomera || jsonTable.kategoriyanomera === filter.kategoriyanomera) 
                        && (filter.propusk === undefined || jsonTable.propusk === filter.propusk)
                        && (!filter.datazaezda.from || new Date(jsonTable.datazaezda) >= filter.datazaezda.from) 
                        && (!filter.datazaezda.to || new Date(jsonTable.datazaezda) <= filter.datazaezda.to)
                        && (!filter.dataviezda.from || new Date(jsonTable.dataviezda) >= filter.dataviezda.from) 
                        && (!filter.dataviezda.to || new Date(jsonTable.dataviezda) <= filter.dataviezda.to)
                        && (!filter.propuskdata.from || new Date(jsonTable.propuskdata) >= filter.propuskdata.from) 
                        && (!filter.propuskdata.to || new Date(jsonTable.propuskdata) <= filter.propuskdata.to); 
                        
                    });
                   },

                   
                    insertItem: function(item) {
                        return $.ajax({
                            type: "POST",
                            url: "/insertQuery",
                            data: item,
                        });
                    },
                    updateItem: function(item) {
                        return $.ajax({
                            type: "Post",
                            url: "/updateQuery",
                            data: item,
                        });
                    },
                    deleteItem: function(item) {
                        return $.ajax({
                            type: "Post",
                            url: "/deleteQuery",
                            data: item,
                            error: (jqXHR , err) => { 
                            if(jqXHR.status == 400){
                                console.log("handle forbidden error code");
                                 }
                            },
                             success: (result, status, jqXHR) => {},
                            });
                    }
              },
                    width: "100%",
                    height: "100%",

                    autoload: true,
            
                    inserting: true,
                   
                    sorting: true,
                    paging: true,
                    filtering: true,
                    editing: true,
                    autoload: true,
                    
                    paging: true,
                    pageSize:200,
                    pageButtonCount: 5,

                    noDataContent: "Нет данных",
                    confirmDeleting: true,
                    deleteConfirm: "Подтверждаете удаление?",

                    loadIndication: true,
                    loadIndicationDelay: 500,
                    loadMessage: "Ждемс...",
                    loadShading: true,

                    data: jsonTable,
                    rowClass: function (item, itemIndex) //item is the data in a row, index is the row number.
                    {

                                      
                        var dateZaezd = new Date(item.datazaezda);
                        var dateViezd = new Date(item.dataviezda);
                        var timeDiff = Math.abs(dateViezd.getTime() - dateZaezd.getTime());
                        var diffDays = Math.ceil(timeDiff / (1000 * 3600 * 24)); 

                        var dateToday = new Date(); /*
                        Math.abs(date1.getTime()-dateToday.getTime() )
                        var timeDiffZaezd = Math.abs(date1.getTime()-dateToday.getTime() );
                        var diffDaysZaezd = Math.ceil(timeDiffZaezd / (1000 * 3600 * 24)); 

                        var timeDiffViezd = dateToday.getTime()-date2.getTime() ;
                        var diffDaysViezd = Math.ceil(timeDiffViezd / (1000 * 3600 * 24)); */
                        var raznicadoviezda= ((dateViezd-dateToday)/ (1000*60*60*24));
                        var raznicadopriezda = ((dateZaezd-dateToday)/ (1000*60*60*24));
                        if  ((!item.propuskdata) || (0>diffDays) || (item.fio==""))
                        {
                            item.sorterColor = 1;
                            return "errorTr";
                        } else if (raznicadoviezda<3 && raznicadoviezda>0) {
                            item.sorterColor =2;
                            return "tridny";
                        }  else if (raznicadopriezda<10 && raznicadopriezda>0) {
                            item.sorterColor = 3;
                             return "jelti";
                        } 

                        else if (raznicadopriezda>10) {
                            item.sorterColor = 4;
                             return "sini";
                        } 
                     else if ((dateViezd-dateToday)<0){
                            item.sorterColor = 6;
                            return "ubil";    
                        }  
                        else if (dateToday.getFullYear() >= dateZaezd.getFullYear() && dateToday.getMonth() >=  dateZaezd.getMonth() && dateToday.getDay() >=  dateZaezd.getDay()) {
                            item.sorterColor = 5;
                            return "pribil";}
                        else 
                        { item.sorterColor =7;  return "nichego";}
                    },
                    
                    fields: [
                    { name: "sorterColor", sorting:true,  css: "hide", width:0,type: "number" },
                        { name: "id", css: "hide", width:0,type: "number",title: "№" },
                        
                        { name: "gto",align:"Center", type: "text",title: "ГТО"},
                        
                        { name: "fio",align:"Center", type: "text",title: "ФИО"},
                        { name: "doljnost",align:"Center", type: "text",title: "Должность"},
                        { name: "email",align:"Center",width:120, type: "text", title: "Почта"},
                        { name: "propuskdata",align:"Center",width:80, type: "date", title: "Пропуск"},
                        { name: "telephone",align:"Center",width:55, type: "number", title: "Номер"},
                        { name: "ranizaezd",align:"Center",width:31, type: "checkbox", sorting: false,title: "Ран. Заезд",
                        
                        insertTemplate: function() {
                                var $result = jsGrid.fields.checkbox.prototype.insertTemplate.call(this);
                                $result.addClass("checkzoom");
                                return $result;
                            },
                        itemTemplate:function() {
                                var $result = jsGrid.fields.checkbox.prototype.insertTemplate.call(this);
                                $result.addClass("checkzoom");
                                return $result;
                            },    
                        filtercss: "checkzoom", 
                         }, 
                        { name: "vremyzaezda",align:"Center",width:80, type: "text", title: "Время заезда"},
                        { name: "datazaezda",align:"Center",width:50, type: "date", title: "Дата заезда"},
                        { name: "dataviezda",align:"Center",width:50, type: "date", title: "Дата выезда"},
                        { name: "comment",width:80,align:"Center", type: "text", title: "Комментарии"},
                        { name: "gostinicaname",width:80,align:"Center", type: "text", title: "Назв. гостиницы"},
                       kategoriyanomeraselect,
                        { name: "cenazasutki", width:40,  type: "number",title: "Номер аппарт." },
                        { name: "kolvosutok",width:33, type: "number",title: "Кол-во суток" },
                        { name: "cenaitogo", width:33, css: "hide", width:0, type: "number",title: "Цена итого" },
                        {headerTemplate: function() {
                                var sss=  $("<button>").attr("type", "button").text("Засел.")
                                        .on("click", function () {
                                            deleteSelectedItemsZaselenie(1);
                                        });
                                        var sss1=  $("<button>").attr("type", "button").text("Прод.")
                                        .on("click", function () {
                                            deleteSelectedItemsZaselenie(2);
                                        });
                                var divsss = $("<div>");
                                sss1.addClass("btn btn-success");
                                sss.addClass("btn btn-success");
                                sss.width(80);
                                sss1.width(80);
                                divsss.append(sss);
                                divsss.append(sss1);
                                return divsss;
                            },
                        itemTemplate: function(_, item) {
                                var checkbox1 = $("<input>").attr("type", "checkbox")
                                        .prop("checked", $.inArray(item, selectedItemsZaselenie) > -1)
                                        .on("change", function () {
                                            $(this).is(":checked") ? selectItemZaselenie(item) : unselectItemZaselenie(item);
                                            event.stopPropagation();
                                        });
                                        checkbox1.addClass("checkzoom");
                                        checkbox1.attr("autocomplete","off");
                                return checkbox1; 
                            },
                        align: "center",
                         width: 50,
                         sorting: false,
                         name:"massemailzasel"
                        },
                        { type: "control" , name:"control",  width: 70,
                                itemTemplate: function(value, item) {
                                    var $result = jsGrid.fields.control.prototype.itemTemplate.apply(this, arguments);
                                    
                                    var $customButton = $("<button>")
                                        .text("Засел.")
                                        .addClass("btn btn-primary btn-sm")
                                        .click(function(e) {
                                                if (getConfirmation()) {
                                                var xhr = new XMLHttpRequest();
                                                xhr.onreadystatechange = function () {
                                                if (this.readyState == 4) {
                                                        if (this.status >= 200 && xhr.status < 300) {
                                                            alert('Письмо отправлено');
                                                        } else 
                                                        {
                                                            alert('Что-то пошло не так... Письмо скорее всего не отправлено');
                                                        }
                                                    }
                                                }
                                                xhr.open('POST', '/emailSend',true);
                                                xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                                                xhr.send('emailSendStatus=1&fio='+item.fio+'&datazaezda='+item.datazaezda+'&dataviezda='+item.dataviezda+'&telephone='+item.telephone+'&kolvosutok='+item.kolvosutok+'&kategoriyanomera='+item.kategoriyanomera+'&email='+item.email+'&ranizaezd='+item.ranizaezd+'&vremyzaezda='+item.vremyzaezda+'&propuskdata='+item.propuskdata);
                                            }
                                        e.stopPropagation();
                                        });
                                        var $customButton1 = $("<button>")
                                        .text("Продл.")
                                        .addClass("btn btn-primary btn-sm")
                                        .click(function(e) {
                                                if (getConfirmation()) {
                                                var xhr = new XMLHttpRequest();
                                                xhr.onreadystatechange = function () {
                                                if (this.readyState == 4) {
                                                        if (this.status >= 200 && xhr.status < 300) {
                                                            alert('Письмо отправлено');
                                                        } else 
                                                        {
                                                            alert('Что-то пошло не так...');
                                                        }
                                                    }
                                                }
                                                xhr.open('POST', '/emailSend', true);
                                                xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                                                xhr.send('emailSendStatus=2&fio='+item.fio+'&datazaezda='+item.datazaezda+'&dataviezda='+item.dataviezda+'&telephone='+item.telephone+'&kolvosutok='+item.kolvosutok+'&kategoriyanomera='+item.kategoriyanomera+'&email='+item.email+'&ranizaezd='+item.ranizaezd+'&vremyzaezda='+item.vremyzaezda+'&propuskdata='+item.propuskdata);
                                            } 
                                         e.stopPropagation();
                                        });
                                        
                                        var $customButton3= $("<button>")
                                        .text("Заявка")
                                        .addClass("btn btn-light")
                                        .click(function(e) {
                                                if (myFunctionPromt()) {
                                                var xhr = new XMLHttpRequest();
                                                xhr.onreadystatechange = function () {
                                                if (this.readyState == 4) {
                                                        if (this.status >= 200 && xhr.status < 300) {
                                                            alert('Письмо отправлено');
                                                        } else 
                                                        {
                                                            alert('Что-то пошло не так...');
                                                        }
                                                    }
                                                }
                                                xhr.open('POST', '/emailSend', true);
                                                xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                                                xhr.send('emailSendStatus=3&fio='+item.fio+'&datazaezda='+item.datazaezda+'&dataviezda='+item.dataviezda+'&telephone='+item.telephone+'&kolvosutok='+item.kolvosutok+'&kategoriyanomera='+item.kategoriyanomera+'&email='+item.email+'&ranizaezd='+item.ranizaezd+'&vremyzaezda='+item.vremyzaezda+'&propuskdata='+item.propuskdata+'&appart='+item.cenazasutki+'&promtptxt='+promtptxt);
                                            } 
                                         e.stopPropagation();
                                        });
                                        $customButton3.css("width", "+=119");
                                        var $customDivMy = $("<div>");
                                        $customDivMy.css({"margin-top" : "5px", "margin-left" : "0px", "margin-right" : "0px" } );
                                        $customDivMy.append($customButton);
                                        $customDivMy.append($customButton1);
                                        var $brcustomZz = $("<br/>");
                                        $customDivMy.append($brcustomZz);
                                        $customDivMy.append($customButton3);
                                     
                                    return $result.add($customDivMy);
                                } 
                          }
                    ],
                    
                });

                    
                $(".config-panel input[type=checkbox]").on("click", function() {
                    var $cb = $(this);
                    $("#jsGrid").jsGrid("option", $cb.attr("id"), $cb.is(":checked"));
                });    
                $(".config-panelview input[type=checkbox]").on("click", function() {
                    var $cb1 = $(this);
                    $("#jsGrid").jsGrid("fieldOption", $cb1.attr("name"), "visible", $cb1.is(":checked"));
                });    
                $("#jsGrid").jsGrid("sort", "sorterColor");
                ////////////////////////////////////////////////////
               
                ///////////////////////////////////////////////////////
                var selectedItemsZaselenie = [];
                
                var selectItemZaselenie = function(item) {
                    selectedItemsZaselenie.push(item);
                };

                var unselectItemZaselenie = function(item) {
                    selectedItemsZaselenie = $.grep(selectedItemsZaselenie, function(i) {
                       
                        return i !== item;
                    });
                };

                var deleteSelectedItemsZaselenie = function(mailcode) {
                    if(!selectedItemsZaselenie.length || !confirm("Вы уверены, что хотитет отправить письмо о заселении?"))
                   { alert("Ничего не выбрано");
                        return;}
                        deleteClientsFromDbZaselenie(selectedItemsZaselenie,mailcode);
                    selectedItemsZaselenie =[]
                };
                
                var deleteClientsFromDbZaselenie = function(deletingClients,mailcode) {
                               
                    var nashi = $.map(jsonTable, function(client) {
                        if ( ($.inArray(client, deletingClients) > -1))  
                        { 
                            
                            return client;} 

                            else 
                        {
                            return null;
                        }
                    });
                    var jsonNashiSend =  JSON.stringify(nashi);
                    $("#grid").jsGrid("refresh");
                
                    
                    var xhr = new XMLHttpRequest();
                                                xhr.onreadystatechange = function () {
                                                if (this.readyState == 4) {
                                                        if (this.status >= 200 && xhr.status < 300) {
                                                            alert('Письмо отправлено');
                                                        } else 
                                                        {
                                                            alert('Что-то пошло не так...');
                                                        }
                                                    }
                                                }
                                                xhr.open('POST', '/emailSendMass', true);
                                                xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                                                xhr.send('emailSendStatus='+mailcode+'&myjson='+jsonNashiSend);
                                  
                                     
                };
              }
        }
      }
    xhr.open('GET', '/getQueries');
    xhr.send();
}

getQueries();
</script>



